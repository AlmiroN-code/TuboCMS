# Исправления LEMP.sh для RexTube

## Дата: 20 января 2026

### Проблемы, которые были исправлены

#### 1. **Отсутствие junction таблиц в БД** ❌ → ✅
**Проблема**: Таблица `video_category` и другие junction таблицы не создавались при выполнении миграций, что приводило к ошибке 500 на главной странице.

**Решение**:
- Создана новая миграция `Version20260120000000.php` для создания таблицы `video_category`
- Создана миграция `Version20260120000001.php` для таблицы `user_role`
- Создана миграция `Version20260120000002.php` для таблицы `role_permission`
- Создана миграция `Version20260120000003.php` для таблицы `ad_segment_relation`
- LEMP.sh теперь автоматически создает эти таблицы вручную, если миграции не выполнятся

#### 2. **Обработка ошибок миграций** ❌ → ✅
**Проблема**: При ошибке миграции скрипт не пытался исправить ситуацию.

**Решение**:
- Добавлена проверка статуса выполнения миграций
- При ошибке скрипт автоматически создает недостающие junction таблицы через SQL
- Все миграции помечаются как выполненные
- Добавлена проверка наличия критических таблиц

#### 3. **Отсутствие проверки доступности БД перед кэшированием** ❌ → ✅
**Проблема**: Кэш прогревался без проверки, что БД готова.

**Решение**:
- Добавлена проверка доступности БД перед прогревом кэша
- Команда `doctrine:query:sql "SELECT 1"` проверяет соединение

#### 4. **Webpack конфиг** ❌ → ✅
**Проблема**: Использовался несуществующий метод `configureOptimization()`.

**Решение**:
- LEMP.sh автоматически перезаписывает `webpack.config.js` с правильной конфигурацией
- Используется метод `configureWebpack()` вместо `configureOptimization()`

#### 5. **Doctrine конфиг** ❌ → ✅
**Проблема**: В `doctrine.yaml` были указаны неподдерживаемые параметры.

**Решение**:
- LEMP.sh автоматически перезаписывает `config/packages/doctrine.yaml` с правильной конфигурацией
- Удалены параметры: `auto_generate_proxy_classes`, `enable_lazy_ghost_objects`, `report_fields_where_declared`, `use_savepoints`, `proxy_dir`

#### 6. **Nginx конфиг** ❌ → ✅
**Проблема**: Синтаксическая ошибка в heredoc (`NGINXEOFn;` вместо `NGINXEOF`).

**Решение**:
- Исправлена синтаксис heredoc в LEMP.sh
- Добавлены rate limiting zones для защиты от abuse

#### 7. **Отсутствие SWAP для обработки видео** ❌ → ✅
**Проблема**: Сервер не имел достаточно памяти для обработки больших видео.

**Решение**:
- Добавлена настройка SWAP размером 4GB
- Оптимизированы параметры ядра для видео обработки (`vm.swappiness=10`, `vm.vfs_cache_pressure=50`)

#### 8. **Rate limiting** ❌ → ✅
**Проблема**: Отсутствовала защита от abuse.

**Решение**:
- Добавлены rate limiting zones в Nginx:
  - `login`: 5 запросов в минуту
  - `api`: 30 запросов в минуту
  - `upload`: 2 запроса в минуту
  - `general`: 10 запросов в секунду

### Файлы, которые были изменены

1. **LEMP.sh** - Основной скрипт развертывания
   - Улучшена обработка ошибок миграций
   - Добавлена автоматическая генерация конфигов
   - Добавлены проверки критических таблиц
   - Добавлена настройка SWAP
   - Добавлены rate limiting zones

2. **migrations/Version20260120000000.php** - Новая миграция для `video_category`
3. **migrations/Version20260120000001.php** - Новая миграция для `user_role`
4. **migrations/Version20260120000002.php** - Новая миграция для `role_permission`
5. **migrations/Version20260120000003.php** - Новая миграция для `ad_segment_relation`

### Как использовать обновленный LEMP.sh

```bash
# На сервере (от root)
cd /root
bash LEMP.sh
```

Скрипт автоматически:
1. Установит все необходимые пакеты
2. Создаст БД и пользователя
3. Клонирует репозиторий
4. Установит зависимости (Composer, npm)
5. Исправит конфиги (webpack, doctrine)
6. Соберет фронтенд
7. Выполнит миграции (с автоматическим созданием недостающих таблиц)
8. Создаст администратора
9. Настроит Nginx, PHP-FPM, Firewall, SSL
10. Запустит Messenger Worker

### Проверка после развертывания

```bash
# Проверить, что все сервисы запущены
systemctl status nginx
systemctl status php8.4-fpm
systemctl status mariadb
systemctl status seexxx-messenger

# Проверить логи
tail -f /var/log/nginx/seexxx.online_error.log
tail -f /var/log/nginx/seexxx.online_access.log

# Проверить БД
mysql -u almiron -p'Mtn999Un86@' seexxx -e "SHOW TABLES;"

# Проверить, что таблица video_category существует
mysql -u almiron -p'Mtn999Un86@' seexxx -e "DESC video_category;"
```

### Критические таблицы, которые должны существовать

- `user` - Пользователи
- `video` - Видео
- `category` - Категории
- `tag` - Теги
- `comment` - Комментарии
- `video_category` - Связь видео и категорий (junction table)
- `video_tag` - Связь видео и тегов (junction table)
- `video_model` - Связь видео и моделей (junction table)
- `user_role` - Связь пользователей и ролей (junction table)
- `role_permission` - Связь ролей и разрешений (junction table)

### Результат

После выполнения LEMP.sh:
- ✅ Сайт доступен по адресу `http://seexxx.online`
- ✅ phpMyAdmin доступен по адресу `http://control.gmnode.ru/phpmyadmin`
- ✅ Главная страница загружается без ошибок 500
- ✅ Админ панель доступна
- ✅ Видео обрабатываются асинхронно через Messenger
- ✅ Все junction таблицы созданы
- ✅ Rate limiting защищает от abuse
- ✅ SWAP настроен для обработки больших видео
