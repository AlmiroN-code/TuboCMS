{% extends 'admin/base.html.twig' %}

{% block title %}{{ test ? 'Редактировать A/B тест' : 'Создать A/B тест' }}{% endblock %}

{% block content %}
<div class="bg-white shadow rounded-md">
    <div class="px-6 py-4 border-b border-gray-200">
        <h1 class="text-xl font-semibold text-gray-900">
            {{ test ? 'Редактировать A/B тест' : 'Создать A/B тест' }}
        </h1>
    </div>

    <form method="post" class="p-6 space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {# Основная информация #}
            <div class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Название теста</label>
                    <input type="text" id="name" name="name" 
                           value="{{ test ? test.name : '' }}" 
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" 
                           required>
                </div>

                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Описание</label>
                    <textarea id="description" name="description" rows="3" 
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">{{ test ? test.description : '' }}</textarea>
                </div>

                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700">Статус</label>
                    <select id="status" name="status" 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        {% set statuses = {
                            'draft': 'Черновик',
                            'running': 'Запущен',
                            'paused': 'Приостановлен',
                            'completed': 'Завершен'
                        } %}
                        {% for value, label in statuses %}
                            <option value="{{ value }}" {{ test and test.status == value ? 'selected' : '' }}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="winner_metric" class="block text-sm font-medium text-gray-700">Метрика победителя</label>
                    <select id="winner_metric" name="winner_metric" 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        {% set metrics = {
                            'ctr': 'CTR (Click-through rate)',
                            'conversions': 'Конверсии',
                            'revenue': 'Доход'
                        } %}
                        {% for value, label in metrics %}
                            <option value="{{ value }}" {{ test and test.winnerMetric == value ? 'selected' : '' }}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            {# Настройки теста #}
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="traffic_split_a" class="block text-sm font-medium text-gray-700">Трафик варианта A (%)</label>
                        <input type="number" id="traffic_split_a" name="traffic_split_a" 
                               value="{{ test ? test.trafficSplitA : 50 }}" 
                               min="1" max="99"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="traffic_split_b" class="block text-sm font-medium text-gray-700">Трафик варианта B (%)</label>
                        <input type="number" id="traffic_split_b" name="traffic_split_b" 
                               value="{{ test ? test.trafficSplitB : 50 }}" 
                               min="1" max="99"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="start_date" class="block text-sm font-medium text-gray-700">Дата начала</label>
                        <input type="datetime-local" id="start_date" name="start_date" 
                               value="{{ test and test.startDate ? test.startDate|date('Y-m-d\\TH:i') : '' }}"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="end_date" class="block text-sm font-medium text-gray-700">Дата окончания</label>
                        <input type="datetime-local" id="end_date" name="end_date" 
                               value="{{ test and test.endDate ? test.endDate|date('Y-m-d\\TH:i') : '' }}"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                </div>
            </div>
        </div>

        {# Выбор объявлений для вариантов #}
        <div class="border-t pt-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Варианты объявлений</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="ad_variant_a" class="block text-sm font-medium text-gray-700">Вариант A</label>
                    <select id="ad_variant_a" name="ad_variant_a" 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="">Выберите объявление</option>
                        {% for ad in ads %}
                            <option value="{{ ad.id }}" 
                                    {{ test and test.variantA and test.variantA.id == ad.id ? 'selected' : '' }}>
                                {{ ad.name }} ({{ ad.format }})
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="ad_variant_b" class="block text-sm font-medium text-gray-700">Вариант B</label>
                    <select id="ad_variant_b" name="ad_variant_b" 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="">Выберите объявление</option>
                        {% for ad in ads %}
                            <option value="{{ ad.id }}" 
                                    {{ test and test.variantB and test.variantB.id == ad.id ? 'selected' : '' }}>
                                {{ ad.name }} ({{ ad.format }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        {# Кнопки действий #}
        <div class="flex justify-between pt-6 border-t">
            <a href="{{ path('admin_ads_abtests') }}" 
               class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                Отмена
            </a>
            <button type="submit" 
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                {{ test ? 'Обновить тест' : 'Создать тест' }}
            </button>
        </div>
    </form>
</div>

<script>
// Автоматическое обновление процентов трафика
document.getElementById('traffic_split_a').addEventListener('input', function() {
    const valueA = parseInt(this.value) || 0;
    const valueB = 100 - valueA;
    document.getElementById('traffic_split_b').value = valueB;
});

document.getElementById('traffic_split_b').addEventListener('input', function() {
    const valueB = parseInt(this.value) || 0;
    const valueA = 100 - valueB;
    document.getElementById('traffic_split_a').value = valueA;
});
</script>
{% endblock %}