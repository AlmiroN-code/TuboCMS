{% extends 'admin/base.html.twig' %}

{% block title %}Статистика: {{ ad.name }}{% endblock %}
{% block page_title %}Статистика объявления{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{{ path('admin_ads_list') }}" class="text-blue-600 hover:text-blue-800">← Назад к списку</a>
</div>

<div class="bg-white rounded-md shadow p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h2 class="text-xl font-bold text-gray-900">{{ ad.name }}</h2>
            <p class="text-sm text-gray-500">{{ ad.placement.name }} • {{ ad.format|title }}</p>
        </div>
        <div class="flex items-center space-x-2">
            <span class="px-3 py-1 rounded-full text-sm font-medium
                {% if ad.status == 'active' %}bg-green-100 text-green-800
                {% elseif ad.status == 'paused' %}bg-yellow-100 text-yellow-800
                {% else %}bg-gray-100 text-gray-800{% endif %}">
                {{ ad.status }}
            </span>
            {% if ad.isActive %}
                <span class="px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">Активно</span>
            {% else %}
                <span class="px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">Неактивно</span>
            {% endif %}
        </div>
    </div>
</div>

{# Основные метрики #}
<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-6">
    <div class="bg-white rounded-md shadow p-4">
        <p class="text-sm text-gray-500">Показы</p>
        <p class="text-2xl font-bold text-gray-900">{{ ad.impressionsCount|number_format }}</p>
        <p class="text-xs text-gray-400">Уникальных: {{ ad.uniqueImpressionsCount|number_format }}</p>
    </div>
    <div class="bg-white rounded-md shadow p-4">
        <p class="text-sm text-gray-500">Клики</p>
        <p class="text-2xl font-bold text-gray-900">{{ ad.clicksCount|number_format }}</p>
        <p class="text-xs text-gray-400">Уникальных: {{ ad.uniqueClicksCount|number_format }}</p>
    </div>
    <div class="bg-white rounded-md shadow p-4">
        <p class="text-sm text-gray-500">CTR</p>
        <p class="text-2xl font-bold text-blue-600">{{ ad.ctr }}%</p>
    </div>
    <div class="bg-white rounded-md shadow p-4">
        <p class="text-sm text-gray-500">Потрачено</p>
        <p class="text-2xl font-bold text-gray-900">${{ ad.spentAmount|number_format(2) }}</p>
        {% if ad.budget %}
            <p class="text-xs text-gray-400">Бюджет: ${{ ad.budget|number_format(2) }}</p>
        {% endif %}
    </div>
    <div class="bg-white rounded-md shadow p-4">
        <p class="text-sm text-gray-500">CPM</p>
        <p class="text-2xl font-bold text-gray-900">${{ ad.cpm ?? '0.00' }}</p>
    </div>
    <div class="bg-white rounded-md shadow p-4">
        <p class="text-sm text-gray-500">CPC</p>
        <p class="text-2xl font-bold text-gray-900">${{ ad.cpc ?? '0.00' }}</p>
    </div>
    <div class="bg-white rounded-md shadow p-4">
        <p class="text-sm text-gray-500">Конверсии</p>
        <p class="text-2xl font-bold text-green-600">{{ aggregated.totalConversions ?? 0 }}</p>
    </div>
</div>

{# Фильтр по периоду #}
<div class="bg-white rounded-md shadow p-4 mb-6">
    <form method="GET" class="flex items-center space-x-4">
        <label class="text-sm text-gray-600">Период:</label>
        <select name="days" onchange="this.form.submit()" class="border-gray-300 rounded-md text-sm">
            <option value="7" {{ days == 7 ? 'selected' : '' }}>7 дней</option>
            <option value="14" {{ days == 14 ? 'selected' : '' }}>14 дней</option>
            <option value="30" {{ days == 30 ? 'selected' : '' }}>30 дней</option>
            <option value="90" {{ days == 90 ? 'selected' : '' }}>90 дней</option>
        </select>
    </form>
</div>

{# Статистика по дням #}
<div class="bg-white rounded-md shadow overflow-hidden">
    <div class="px-6 py-4 border-b">
        <h3 class="text-lg font-medium text-gray-900">Статистика по дням</h3>
    </div>
    
    {% if dailyStats|length > 0 %}
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Дата</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Показы</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Клики</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">CTR</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Потрачено</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Конверсии</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
            {% for stat in dailyStats %}
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 text-sm text-gray-900">{{ stat.date|date('d.m.Y') }}</td>
                <td class="px-6 py-4 text-sm text-gray-900 text-right">{{ stat.impressions|number_format }}</td>
                <td class="px-6 py-4 text-sm text-gray-900 text-right">{{ stat.clicks|number_format }}</td>
                <td class="px-6 py-4 text-sm text-gray-900 text-right">
                    {% if stat.impressions > 0 %}
                        {{ ((stat.clicks / stat.impressions) * 100)|number_format(2) }}%
                    {% else %}
                        0%
                    {% endif %}
                </td>
                <td class="px-6 py-4 text-sm text-gray-900 text-right">${{ stat.spent|number_format(2) }}</td>
                <td class="px-6 py-4 text-sm text-gray-900 text-right">{{ stat.conversions }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot class="bg-gray-50">
            <tr>
                <td class="px-6 py-4 text-sm font-medium text-gray-900">Итого</td>
                <td class="px-6 py-4 text-sm font-medium text-gray-900 text-right">{{ aggregated.totalImpressions|number_format }}</td>
                <td class="px-6 py-4 text-sm font-medium text-gray-900 text-right">{{ aggregated.totalClicks|number_format }}</td>
                <td class="px-6 py-4 text-sm font-medium text-gray-900 text-right">
                    {% if aggregated.totalImpressions > 0 %}
                        {{ ((aggregated.totalClicks / aggregated.totalImpressions) * 100)|number_format(2) }}%
                    {% else %}
                        0%
                    {% endif %}
                </td>
                <td class="px-6 py-4 text-sm font-medium text-gray-900 text-right">${{ aggregated.totalSpent|number_format(2) }}</td>
                <td class="px-6 py-4 text-sm font-medium text-gray-900 text-right">{{ aggregated.totalConversions }}</td>
            </tr>
        </tfoot>
    </table>
    {% else %}
    <div class="px-6 py-12 text-center text-gray-500">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
        <p class="mt-2">Нет данных за выбранный период</p>
    </div>
    {% endif %}
</div>

{# Действия #}
<div class="mt-6 flex space-x-4">
    <a href="{{ path('admin_ads_edit', {id: ad.id}) }}" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
        Редактировать
    </a>
    <form method="POST" action="{{ path('admin_ads_reset_stats', {id: ad.id}) }}" onsubmit="return confirm('Сбросить всю статистику?')">
        <button type="submit" class="bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700">
            Сбросить статистику
        </button>
    </form>
</div>
{% endblock %}
