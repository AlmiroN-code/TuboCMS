{% extends 'admin/base.html.twig' %}

{% block title %}Миграция файлов{% endblock %}
{% block page_title %}Миграция файлов между хранилищами{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{{ path('admin_storage') }}" class="text-blue-600 hover:text-blue-800">
        ← Назад к списку хранилищ
    </a>
</div>

{# Активные миграции #}
{% if activeMigrations is defined and activeMigrations|length > 0 %}
<div class="mb-6">
    <h3 class="text-lg font-medium mb-3">Активные миграции</h3>
    <div class="space-y-3">
        {% for migration in activeMigrations %}
        <div class="bg-blue-50 border border-blue-200 rounded-md p-4" data-migration-id="{{ migration.id }}">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center">
                    <svg class="animate-spin h-5 w-5 text-blue-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="font-medium text-blue-800">{{ migration.sourceName }} → {{ migration.destinationName }}</span>
                </div>
                <span class="text-sm text-blue-600">{{ migration.progressPercent }}%</span>
            </div>
            <div class="w-full bg-blue-200 rounded-full h-2 mb-2">
                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: {{ migration.progressPercent }}%"></div>
            </div>
            <div class="text-sm text-blue-700">
                Обработано: {{ migration.processedCount }} из {{ migration.totalFiles }} 
                (✓ {{ migration.successCount }} / ✗ {{ migration.failureCount }})
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{# Последние завершённые миграции #}
{% if recentMigrations is defined and recentMigrations|length > 0 %}
<div class="mb-6">
    <h3 class="text-lg font-medium mb-3">Последние миграции</h3>
    <div class="bg-white rounded-md shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Направление</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Файлов</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Успешно</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ошибок</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Завершено</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for migration in recentMigrations %}
                <tr class="{{ migration.hasFailures ? 'bg-red-50' : 'bg-green-50' }}">
                    <td class="px-4 py-3 text-sm">{{ migration.sourceName }} → {{ migration.destinationName }}</td>
                    <td class="px-4 py-3 text-sm">{{ migration.totalFiles }}</td>
                    <td class="px-4 py-3 text-sm text-green-600 font-medium">{{ migration.successCount }}</td>
                    <td class="px-4 py-3 text-sm {{ migration.failureCount > 0 ? 'text-red-600 font-medium' : 'text-gray-500' }}">
                        {{ migration.failureCount }}
                        {% if migration.failureCount > 0 %}
                        <button type="button" 
                                onclick="showFailures('{{ migration.id }}')"
                                class="ml-2 text-xs text-red-600 hover:text-red-800 underline">
                            подробнее
                        </button>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">{{ migration.completedAt|date('d.m.Y H:i') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Форма миграции -->
    <div class="bg-white rounded-md shadow p-6">
        <h3 class="text-lg font-medium mb-4">Настройка миграции</h3>
        
        <form id="migrationForm" class="space-y-4">
            <!-- Источник -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Источник (откуда)
                </label>
                <select name="source" id="sourceStorage" 
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="local">Локальное хранилище ({{ localFileCount }} файлов)</option>
                    {% for stat in storageStats %}
                        <option value="{{ stat.storage.id }}">
                            {{ stat.storage.name }} ({{ stat.fileCount }} файлов)
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Назначение -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Назначение (куда)
                </label>
                <select name="destination" id="destinationStorage" 
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="local">Локальное хранилище</option>
                    {% for stat in storageStats %}
                        {% if stat.storage.enabled %}
                            <option value="{{ stat.storage.id }}">
                                {{ stat.storage.name }}
                                {% if stat.storage.default %}(по умолчанию){% endif %}
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>

            <!-- Информация о миграции -->
            <div id="migrationInfo" class="hidden bg-blue-50 border border-blue-200 rounded p-4">
                <div class="text-sm text-blue-800">
                    <span id="migrationSummary"></span>
                </div>
            </div>

            <!-- Предупреждение -->
            <div id="migrationWarning" class="hidden bg-yellow-50 border border-yellow-200 rounded p-4">
                <div class="text-sm text-yellow-800">
                    <strong>Внимание:</strong> Миграция может занять длительное время в зависимости от количества и размера файлов.
                    Файлы будут скопированы в фоновом режиме.
                </div>
            </div>

            <!-- Ошибка -->
            <div id="migrationError" class="hidden bg-red-50 border border-red-200 rounded p-4">
                <div class="text-sm text-red-800" id="migrationErrorText"></div>
            </div>

            <!-- Прогресс миграции -->
            <div id="migrationProgress" class="hidden">
                <div class="bg-green-50 border border-green-200 rounded p-4">
                    <div class="flex items-center mb-2">
                        <svg class="animate-spin h-5 w-5 text-green-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-sm font-medium text-green-800">Миграция запущена</span>
                    </div>
                    <div class="text-sm text-green-700" id="migrationProgressText"></div>
                    <div class="mt-2 text-xs text-green-600">
                        Файлы обрабатываются в фоновом режиме. Вы можете закрыть эту страницу.
                    </div>
                </div>
            </div>

            <!-- Кнопки -->
            <div class="flex gap-3">
                <button type="button" id="checkMigrationBtn"
                        class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
                    Проверить
                </button>
                <button type="submit" id="startMigrationBtn" disabled
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded disabled:opacity-50 disabled:cursor-not-allowed">
                    Начать миграцию
                </button>
            </div>
        </form>
    </div>

    <!-- Статистика хранилищ -->
    <div class="bg-white rounded-md shadow p-6">
        <h3 class="text-lg font-medium mb-4">Статистика хранилищ</h3>
        
        <div class="space-y-3">
            <!-- Локальное хранилище -->
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                <div>
                    <div class="font-medium">Локальное хранилище</div>
                    <div class="text-sm text-gray-500">Файлы без привязки к удалённому хранилищу</div>
                </div>
                <div class="text-right">
                    <div class="text-lg font-semibold">{{ localFileCount }}</div>
                    <div class="text-xs text-gray-500">файлов</div>
                </div>
            </div>

            {% for stat in storageStats %}
                <div class="flex items-center justify-between p-3 {{ stat.storage.enabled ? 'bg-green-50' : 'bg-red-50' }} rounded">
                    <div>
                        <div class="font-medium">
                            {{ stat.storage.name }}
                            {% if stat.storage.default %}
                                <span class="ml-2 px-2 py-0.5 text-xs bg-yellow-100 text-yellow-800 rounded">по умолчанию</span>
                            {% endif %}
                        </div>
                        <div class="text-sm text-gray-500">
                            {% set typeLabels = {
                                'local': 'Локальное',
                                'ftp': 'FTP',
                                'sftp': 'SFTP',
                                'http': 'HTTP/API'
                            } %}
                            {{ typeLabels[stat.storage.type] ?? stat.storage.type }}
                            {% if not stat.storage.enabled %}
                                <span class="text-red-600">(отключено)</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-semibold">{{ stat.fileCount }}</div>
                        <div class="text-xs text-gray-500">файлов</div>
                    </div>
                </div>
            {% else %}
                <div class="text-gray-500 text-center py-4">
                    Удалённые хранилища не настроены
                </div>
            {% endfor %}
        </div>
    </div>
</div>

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sourceSelect = document.getElementById('sourceStorage');
    const destinationSelect = document.getElementById('destinationStorage');
    const checkBtn = document.getElementById('checkMigrationBtn');
    const startBtn = document.getElementById('startMigrationBtn');
    const migrationInfo = document.getElementById('migrationInfo');
    const migrationWarning = document.getElementById('migrationWarning');
    const migrationError = document.getElementById('migrationError');
    const migrationProgress = document.getElementById('migrationProgress');
    const migrationSummary = document.getElementById('migrationSummary');
    const migrationErrorText = document.getElementById('migrationErrorText');
    const migrationProgressText = document.getElementById('migrationProgressText');

    let currentFileCount = 0;
    let currentMigrationId = null;
    let progressInterval = null;

    function resetState() {
        migrationInfo.classList.add('hidden');
        migrationWarning.classList.add('hidden');
        migrationError.classList.add('hidden');
        migrationProgress.classList.add('hidden');
        startBtn.disabled = true;
        currentFileCount = 0;
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }
    }

    // Сброс при изменении выбора
    sourceSelect.addEventListener('change', resetState);
    destinationSelect.addEventListener('change', resetState);

    // Проверка миграции
    checkBtn.addEventListener('click', function() {
        const source = sourceSelect.value;
        const destination = destinationSelect.value;

        if (source === destination) {
            migrationError.classList.remove('hidden');
            migrationErrorText.textContent = 'Источник и назначение должны быть разными';
            migrationInfo.classList.add('hidden');
            migrationWarning.classList.add('hidden');
            startBtn.disabled = true;
            return;
        }

        checkBtn.disabled = true;
        checkBtn.textContent = 'Проверка...';

        fetch('{{ path('admin_storage_migration_count') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `source=${source}&destination=${destination}`
        })
        .then(response => response.json())
        .then(data => {
            checkBtn.disabled = false;
            checkBtn.textContent = 'Проверить';

            if (data.success) {
                migrationError.classList.add('hidden');
                currentFileCount = data.fileCount;
                
                if (data.fileCount === 0) {
                    migrationInfo.classList.remove('hidden');
                    migrationSummary.textContent = `Нет файлов для миграции из "${data.sourceName}"`;
                    migrationWarning.classList.add('hidden');
                    startBtn.disabled = true;
                } else {
                    migrationInfo.classList.remove('hidden');
                    migrationSummary.textContent = `Будет перенесено ${data.fileCount} файлов из "${data.sourceName}" в "${data.destinationName}"`;
                    migrationWarning.classList.remove('hidden');
                    startBtn.disabled = false;
                }
            } else {
                migrationError.classList.remove('hidden');
                migrationErrorText.textContent = data.message;
                migrationInfo.classList.add('hidden');
                migrationWarning.classList.add('hidden');
                startBtn.disabled = true;
            }
        })
        .catch(error => {
            checkBtn.disabled = false;
            checkBtn.textContent = 'Проверить';
            migrationError.classList.remove('hidden');
            migrationErrorText.textContent = 'Ошибка при проверке: ' + error.message;
        });
    });

    // Функция обновления прогресса миграции
    function updateMigrationProgress(migrationId) {
        fetch(`{{ path('admin_storage') }}/migration/${migrationId}/status`)
        .then(response => response.json())
        .then(data => {
            if (!data.found) {
                clearInterval(progressInterval);
                return;
            }
            
            const progressBar = document.getElementById('migrationProgressBar');
            const progressPercent = document.getElementById('migrationProgressPercent');
            const progressDetails = document.getElementById('migrationProgressDetails');
            
            if (progressBar) progressBar.style.width = `${data.progressPercent}%`;
            if (progressPercent) progressPercent.textContent = `${data.progressPercent}%`;
            if (progressDetails) {
                progressDetails.textContent = `Обработано: ${data.processedCount} из ${data.totalFiles} (✓ ${data.successCount} / ✗ ${data.failureCount})`;
            }
            
            if (data.isComplete) {
                clearInterval(progressInterval);
                migrationProgressText.innerHTML = `
                    <div class="font-medium ${data.hasFailures ? 'text-yellow-800' : 'text-green-800'}">
                        Миграция завершена!
                    </div>
                    <div class="mt-1">
                        Успешно: ${data.successCount}, Ошибок: ${data.failureCount}
                    </div>
                    ${data.hasFailures ? '<div class="mt-2"><a href="#" onclick="showFailures(\'' + migrationId + '\'); return false;" class="text-yellow-700 underline">Показать ошибки</a></div>' : ''}
                `;
                
                // Разблокируем форму
                sourceSelect.disabled = false;
                destinationSelect.disabled = false;
                checkBtn.disabled = false;
                startBtn.disabled = true;
            }
        })
        .catch(error => {
            console.error('Error updating progress:', error);
        });
    }

    // Начало миграции
    document.getElementById('migrationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const source = sourceSelect.value;
        const destination = destinationSelect.value;

        if (source === destination) {
            migrationError.classList.remove('hidden');
            migrationErrorText.textContent = 'Источник и назначение должны быть разными';
            return;
        }

        if (!confirm(`Вы уверены, что хотите начать миграцию ${currentFileCount} файлов? Этот процесс будет выполняться в фоновом режиме.`)) {
            return;
        }

        startBtn.disabled = true;
        startBtn.textContent = 'Запуск...';
        checkBtn.disabled = true;

        fetch('{{ path('admin_storage_migration_start') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `source=${source}&destination=${destination}`
        })
        .then(response => response.json())
        .then(data => {
            startBtn.textContent = 'Начать миграцию';

            if (data.success) {
                currentMigrationId = data.migrationId;
                migrationError.classList.add('hidden');
                migrationInfo.classList.add('hidden');
                migrationWarning.classList.add('hidden');
                migrationProgress.classList.remove('hidden');
                migrationProgressText.innerHTML = `
                    <div class="mb-2">
                        ${data.queuedCount} файлов поставлено в очередь для переноса из "${data.sourceName}" в "${data.destinationName}"
                    </div>
                    <div class="w-full bg-green-200 rounded-full h-2 mb-2">
                        <div id="migrationProgressBar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span id="migrationProgressDetails">Ожидание обработки...</span>
                        <span id="migrationProgressPercent">0%</span>
                    </div>
                `;
                
                // Блокируем форму после успешного запуска
                sourceSelect.disabled = true;
                destinationSelect.disabled = true;
                
                // Запускаем периодическое обновление прогресса
                progressInterval = setInterval(() => updateMigrationProgress(currentMigrationId), 3000);
            } else {
                migrationError.classList.remove('hidden');
                migrationErrorText.textContent = data.message;
                startBtn.disabled = false;
                checkBtn.disabled = false;
            }
        })
        .catch(error => {
            startBtn.disabled = false;
            startBtn.textContent = 'Начать миграцию';
            checkBtn.disabled = false;
            migrationError.classList.remove('hidden');
            migrationErrorText.textContent = 'Ошибка при запуске миграции: ' + error.message;
        });
    });
});

// Функция показа ошибок миграции
function showFailures(migrationId) {
    fetch(`{{ path('admin_storage') }}/migration/${migrationId}/failures`)
    .then(response => response.json())
    .then(data => {
        if (data.failures && data.failures.length > 0) {
            let message = 'Ошибки миграции:\n\n';
            data.failures.forEach((failure, index) => {
                message += `${index + 1}. Файл #${failure.videoFileId}: ${failure.error}\n`;
            });
            alert(message);
        } else {
            alert('Ошибок не найдено');
        }
    })
    .catch(error => {
        alert('Ошибка при загрузке списка ошибок: ' + error.message);
    });
}
</script>
{% endblock %}
{% endblock %}
