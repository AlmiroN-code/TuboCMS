{% extends 'admin/base.html.twig' %}

{% block title %}{{ model.id ? 'Редактировать модель' : 'Новая модель' }}{% endblock %}
{% block page_title %}{{ model.id ? 'Редактировать модель' : 'Новая модель' }}{% endblock %}

{% block content %}
<div class="bg-white rounded-md shadow p-6">
    <form method="post" enctype="multipart/form-data">
    
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {# Левая колонка - основная информация #}
            <div class="space-y-6">
                <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Основная информация</h3>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Имя *</label>
                    <input type="text" name="display_name" value="{{ model.displayName }}" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Slug</label>
                    <input type="text" name="slug" value="{{ model.slug }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="mt-1 text-sm text-gray-500">Оставьте пустым для автогенерации из имени</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Псевдонимы</label>
                    <input type="text" name="aliases" value="{{ model.aliasesAsString }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Например: Mia K, Mia Khalifa Official">
                    <p class="mt-1 text-sm text-gray-500">Укажите альтернативные имена через запятую</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Биография</label>
                    <textarea name="bio" rows="4"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">{{ model.bio }}</textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Пол</label>
                    <select name="gender" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="female" {{ model.gender == 'female' ? 'selected' : '' }}>Женский</option>
                        <option value="male" {{ model.gender == 'male' ? 'selected' : '' }}>Мужской</option>
                        <option value="trans" {{ model.gender == 'trans' ? 'selected' : '' }}>Транс</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Дата рождения</label>
                        <input type="date" name="birth_date" value="{{ model.birthDate ? model.birthDate|date('Y-m-d') : '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Возраст</label>
                        <input type="number" name="age" value="{{ model.age }}" min="18" max="99"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="mt-1 text-sm text-gray-500">Вычисляется автоматически из даты рождения</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Страна</label>
                        <input type="text" name="country" value="{{ model.country }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Этничность</label>
                        <input type="text" name="ethnicity" value="{{ model.ethnicity }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Начало карьеры</label>
                    <input type="date" name="career_start" value="{{ model.careerStart ? model.careerStart|date('Y-m-d') : '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>


            {# Правая колонка - внешность и медиа #}
            <div class="space-y-6">
                <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Внешность</h3>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Цвет волос</label>
                        <select name="hair_color" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Не указано</option>
                            <option value="black" {{ model.hairColor == 'black' ? 'selected' : '' }}>Чёрный</option>
                            <option value="brown" {{ model.hairColor == 'brown' ? 'selected' : '' }}>Каштановый</option>
                            <option value="blonde" {{ model.hairColor == 'blonde' ? 'selected' : '' }}>Блонд</option>
                            <option value="red" {{ model.hairColor == 'red' ? 'selected' : '' }}>Рыжий</option>
                            <option value="gray" {{ model.hairColor == 'gray' ? 'selected' : '' }}>Седой</option>
                            <option value="other" {{ model.hairColor == 'other' ? 'selected' : '' }}>Другой</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Цвет глаз</label>
                        <select name="eye_color" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Не указано</option>
                            <option value="brown" {{ model.eyeColor == 'brown' ? 'selected' : '' }}>Карий</option>
                            <option value="blue" {{ model.eyeColor == 'blue' ? 'selected' : '' }}>Голубой</option>
                            <option value="green" {{ model.eyeColor == 'green' ? 'selected' : '' }}>Зелёный</option>
                            <option value="gray" {{ model.eyeColor == 'gray' ? 'selected' : '' }}>Серый</option>
                            <option value="hazel" {{ model.eyeColor == 'hazel' ? 'selected' : '' }}>Ореховый</option>
                            <option value="other" {{ model.eyeColor == 'other' ? 'selected' : '' }}>Другой</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Рост (см)</label>
                        <input type="number" name="height" value="{{ model.height }}" min="100" max="250"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Вес (кг)</label>
                        <input type="number" name="weight" value="{{ model.weight }}" min="30" max="200"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Размер груди</label>
                    <input type="text" name="breast_size" value="{{ model.breastSize }}" placeholder="Например: 34C"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="flex space-x-6">
                    <label class="flex items-center">
                        <input type="checkbox" name="has_tattoos" value="1" {{ model.hasTattoos ? 'checked' : '' }}
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <span class="ml-2 text-sm text-gray-700">Татуировки</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="has_piercings" value="1" {{ model.hasPiercings ? 'checked' : '' }}
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <span class="ml-2 text-sm text-gray-700">Пирсинг</span>
                    </label>
                </div>

                <h3 class="text-lg font-medium text-gray-900 border-b pb-2 mt-8">Медиа</h3>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Аватар</label>
                    {% if model.avatar %}
                        <div class="mb-2">
                            <img src="/media/avatars/{{ model.avatar }}" alt="Текущий аватар" class="w-24 h-24 object-cover rounded-full">
                        </div>
                    {% endif %}
                    <input type="file" name="avatar" accept="image/*"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="mt-1 text-sm text-gray-500">Рекомендуемый размер: 400x400 пикселей</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Обложка профиля</label>
                    {% if model.coverPhoto %}
                        <div class="mb-2">
                            <img src="/media/covers/{{ model.coverPhoto }}" alt="Текущая обложка" class="w-full h-24 object-cover rounded">
                        </div>
                    {% endif %}
                    <input type="file" name="cover_photo" accept="image/*"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="mt-1 text-sm text-gray-500">Рекомендуемый размер: 1200x300 пикселей</p>
                </div>
            </div>
        </div>


        {# Статусы - полная ширина #}
        <div class="mt-6 pt-6 border-t">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Статусы</h3>
            <div class="flex flex-wrap gap-6">
                <label class="flex items-center">
                    <input type="checkbox" name="is_active" value="1" {{ model.isActive ? 'checked' : '' }}
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Активна</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="is_verified" value="1" {{ model.isVerified ? 'checked' : '' }}
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Верифицирована</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="is_premium" value="1" {{ model.isPremium ? 'checked' : '' }}
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Премиум</span>
                </label>
            </div>
        </div>

        {# SEO настройки #}
        <div class="mt-6 pt-6 border-t">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">SEO настройки</h3>
                <button type="button" id="generate-seo-btn" 
                        class="inline-flex items-center px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-sm rounded transition-colors"
                        data-type="model" data-id="{{ model.id }}">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    <span class="btn-text">Сгенерировать SEO</span>
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Meta Title</label>
                    <input type="text" name="meta_title" id="meta_title" value="{{ model.metaTitle }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Заголовок страницы для поисковиков">
                    <p class="text-xs text-gray-500 mt-1">Если не указан, генерируется автоматически</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Meta Keywords</label>
                    <input type="text" name="meta_keywords" id="meta_keywords" value="{{ model.metaKeywords }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Ключевые слова через запятую">
                </div>
                
                <div class="lg:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Meta Description</label>
                    <textarea name="meta_description" id="meta_description" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Описание для поисковых систем (150-160 символов)">{{ model.metaDescription }}</textarea>
                    <p class="text-xs text-gray-500 mt-1">Рекомендуемая длина: 150-160 символов</p>
                </div>
            </div>
        </div>

        {# Статистика (только для существующих моделей) #}
        {% if model.id %}
        <div class="mt-6 pt-6 border-t">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Статистика</h3>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div class="bg-gray-50 p-3 rounded">
                    <div class="text-2xl font-bold text-gray-900">{{ model.viewsCount|number_format(0, '', ' ') }}</div>
                    <div class="text-sm text-gray-500">Просмотров</div>
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <div class="text-2xl font-bold text-gray-900">{{ model.subscribersCount|number_format(0, '', ' ') }}</div>
                    <div class="text-sm text-gray-500">Подписчиков</div>
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <div class="text-2xl font-bold text-gray-900">{{ model.videosCount }}</div>
                    <div class="text-sm text-gray-500">Видео</div>
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <div class="text-2xl font-bold text-green-600">{{ model.likesCount|number_format(0, '', ' ') }}</div>
                    <div class="text-sm text-gray-500">Лайков</div>
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <div class="text-2xl font-bold text-red-600">{{ model.dislikesCount|number_format(0, '', ' ') }}</div>
                    <div class="text-sm text-gray-500">Дизлайков</div>
                </div>
            </div>
        </div>
        {% endif %}

        {# Кнопки действий #}
        <div class="mt-6 pt-6 border-t flex space-x-4">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">
                Сохранить
            </button>
            <a href="{{ path('admin_models') }}" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded">
                Отмена
            </a>
        </div>
    </form>
</div>

<script>
(function() {
    const generateBtn = document.getElementById('generate-seo-btn');
    if (!generateBtn) return;
    
    generateBtn.addEventListener('click', async function() {
        const type = this.dataset.type;
        const id = this.dataset.id || null;
        const btnText = this.querySelector('.btn-text');
        const originalText = btnText.textContent;
        
        const data = {
            type: type,
            id: id ? parseInt(id) : null,
            data: {
                display_name: document.querySelector('[name="display_name"]')?.value || '',
                bio: document.querySelector('[name="bio"]')?.value || ''
            }
        };
        
        this.disabled = true;
        btnText.textContent = 'Генерация...';
        
        try {
            const response = await fetch('{{ path("admin_seo_generate") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                if (result.metaTitle) document.getElementById('meta_title').value = result.metaTitle;
                if (result.metaDescription) document.getElementById('meta_description').value = result.metaDescription;
                if (result.metaKeywords) document.getElementById('meta_keywords').value = result.metaKeywords;
                
                btnText.textContent = 'Готово!';
                setTimeout(() => { btnText.textContent = originalText; }, 2000);
            } else {
                btnText.textContent = result.error || 'Ошибка';
                setTimeout(() => { btnText.textContent = originalText; }, 3000);
            }
        } catch (error) {
            console.error('SEO generation error:', error);
            btnText.textContent = 'Ошибка сети';
            setTimeout(() => { btnText.textContent = originalText; }, 3000);
        } finally {
            this.disabled = false;
        }
    });
})();
</script>
{% endblock %}
